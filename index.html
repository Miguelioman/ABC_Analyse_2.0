<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>ABC Analyse Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.hidden { display: none; }
h2 { margin-top: 30px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { cursor: pointer; background: #eee; }
.filter-container { margin-top: 10px; }
#monthsOverview { margin-top: 10px; font-weight: bold; }
.chart-container { width: 600px; margin-top: 20px; }
</style>
</head>
<body>

<h1>ABC Analyse Dashboard</h1>
<p>Upload Ã©Ã©n Excelbestand met meerdere maand-sheets (sheetnaam = maand, bijv. 02-2025, 03-2025, etc.).</p>

<button id="uploadBtn">Upload en verwerk Excel</button>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">

<div id="monthsOverview"></div>

<div id="mainContent" class="hidden">
  <h2>Hoofdoverzicht</h2>
  <table id="mainTable"></table>
</div>

<script>
let allData = {};
let months = [];
const prices = {
  'sokken': 10.95,
  'compressiesokken': 29.99,
  'schoenen': 79.99,
  'mokken': 14.95,
  'sneakers': 99.99
};

document.getElementById("uploadBtn").addEventListener("click", () => {
  document.getElementById("excelFile").click();
});
document.getElementById("excelFile").addEventListener("change", handleExcelUpload);

function standardizeKeys(row) {
  const obj = {};
  Object.keys(row).forEach(k => {
    const cleanKey = k.toLowerCase().replace(/\s+/g, '');
    obj[cleanKey] = row[k];
  });
  return obj;
}

function handleExcelUpload(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const workbook = XLSX.read(e.target.result, {type: 'binary'});
    months = [];
    allData = {};
    workbook.SheetNames.forEach(sheetName => {
      const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
      if (sheetData.length > 0) {
        const month = sheetName.trim();
        months.push(month);
        allData[month] = processMonthData(sheetData);
      }
    });
    console.log("Gehele ingelezen dataset:", allData);
    months.sort((a,b) => {
      const [ma, ya] = a.split('-').map(Number);
      const [mb, yb] = b.split('-').map(Number);
      return ya === yb ? ma - mb : yb - ya;
    });
    document.getElementById("monthsOverview").textContent = "ðŸ“… GeÃ¯mporteerde maanden: " + months.join(', ');
    document.getElementById("mainContent").classList.remove("hidden");
    buildMainTable();
  };
  reader.readAsBinaryString(file);
}

function normalizeType(type) {
  if (!type) return '';
  return type.trim().toLowerCase();
}

function processMonthData(data) {
  // Standaardiseer kolomnamen
  data = data.map(row => standardizeKeys(row));

  // Filter voorraad > 0
  data = data.filter(r => parseFloat(r['beginvoorraad']) > 0);

  // Bereken omzet
  data.forEach(r => {
    r.producttype = normalizeType(r['producttype']);
    r.prijs = prices[r.producttype] || 0;
    r.omzet = (parseFloat(r['verkocht']) || 0) * r.prijs;
  });

  // ABC indeling op basis van omzet
  const sorted = [...data].sort((a,b) => b.omzet - a.omzet);
  let totalOmzet = sorted.reduce((sum,r) => sum + r.omzet, 0);
  let cum = 0;
  sorted.forEach(r => {
    cum += r.omzet;
    let pct = totalOmzet > 0 ? (cum / totalOmzet) * 100 : 0;
    r.categorie = pct <= 80 ? 'A' : pct <= 95 ? 'B' : 'C';
  });

  console.log("Sheet verwerkt:", sorted);
  return sorted;
}

function buildMainTable() {
  const aggregated = {};
  months.forEach(month => {
    allData[month].forEach(r => {
      let key = r['productvariantsku'] + '|' + r['naam'];
      if (!aggregated[key]) {
        aggregated[key] = { 
          SKU: r['productvariantsku'], 
          Naam: r['naam'], 
          Producttype: r['producttype'], 
          VerkochtTotaal: 0, 
          OmzetTotaal: 0, 
          Beloop: '', 
          Scores: [], 
          Voorraad: r['eindvoorraad'] 
        };
      }
      aggregated[key].VerkochtTotaal += parseFloat(r['verkocht']) || 0;
      aggregated[key].OmzetTotaal += r.omzet || 0;
      aggregated[key].Beloop += r.categorie;
      aggregated[key].Scores.push(r.categorie === 'A' ? 1 : r.categorie === 'B' ? 2 : 3);
      aggregated[key].Voorraad = r['eindvoorraad'];
    });
  });

  const rows = Object.values(aggregated).map(p => {
    p.GemScore = (p.Scores.reduce((a,b)=>a+b,0) / p.Scores.length).toFixed(2);
    return p;
  });

  renderTable('mainTable', ['SKU','Naam','Producttype','VerkochtTotaal','OmzetTotaal','Beloop','GemScore','Voorraad'], rows);
}

function renderTable(id, columns, rows) {
  const table = document.getElementById(id);
  let html = '<thead><tr>';
  columns.forEach(c => html += `<th>${c}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r => {
    html += '<tr>';
    columns.forEach(c => html += `<td>${r[c] ?? ''}</td>`);
    html += '</tr>';
  });
  html += '</tbody>';
  table.innerHTML = html;
}
</script>

</body>
</html>
