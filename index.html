<script>
// --- Config & helpers ---
const PRICE_BY_CATEGORY = { sokken:10.95, compressiesokken:29.95, klompen:79.99, mokken:14.99, sneakers:99.99 };
function mapCategory(title){ const t=(title||'').toLowerCase(); if(t.includes('compressie')) return 'compressiesokken'; if(t.includes('sok')) return 'sokken'; if(t.includes('klomp')) return 'klompen'; if(t.includes('mok')) return 'mokken'; if(t.includes('sneak')) return 'sneakers'; return 'overig'; }
function n(v){const x=parseFloat(v); return isNaN(x)?0:x}
function abcScore(letter){ if(letter==='A') return 1; if(letter==='B') return 2; if(letter==='C') return 3; return null }

// Data stores
const monthsData = {}; // raw rows per month
const computed = { byMonth:{} }; // grouped + ABC per month
let aggregated = {}; // aggregated per SKU across months

// DataTables refs
let aggregatedTable = null, productsTable=null, topTable=null, analysisTable=null;
let pieChart=null, trendChart=null, historyChart=null;

// --- CSV upload ---
document.getElementById('uploadBtn').addEventListener('click', ()=>{
  const file = document.getElementById('csvFile').files[0];
  const month = document.getElementById('monthPicker').value;
  if(!file){alert('Selecteer CSV bestand'); return}
  if(!month){alert('Selecteer een maand (YYYY-MM)'); return}

  Papa.parse(file, {
    header:true,
    skipEmptyLines:true,
    complete: (res)=>{
      const raw = res.data;
      if(!raw.length){ alert('Geen data gevonden in CSV'); return; }

      // Maak kolomnamen lowercase zonder spaties voor robuuste mapping
      const normalizeKey = k => (k||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
      const rows = raw.map(r=>{
        const obj = {};
        for(const key in r){
          obj[normalizeKey(key)] = r[key];
        }
        return {
          product_title: obj['product title'] || '',
          variant_title: obj['product variant title'] || '',
          sku: obj['product variant sku'] || obj['sku'] || '',
          start_inv: n(obj['starting inventory units']),
          end_inv: n(obj['ending inventory units']),
          sold: n(obj['inventory units sold']),
          category: mapCategory(obj['product title'] || ''),
        };
      });

      // Laat alles door, filteren doen we pas in de berekeningen
      monthsData[month] = rows;
      recomputeAll();
      refreshMonthSelects();
      updateFilters();
      alert('Upload succesvol: '+rows.length+' regels voor '+month);
    }
  });
});

document.getElementById('clearAll').addEventListener('click', ()=>{ if(!confirm('Verwijder alle data?')) return; for(const k in monthsData) delete monthsData[k]; recomputeAll(); updateFilters(); });

// --- compute ABC per month (on units sold) ---
function computeABCForMonthUnits(month){
  const rows = monthsData[month]||[];
  // group by product+sku
  const grouped = {};
  rows.forEach(r=>{
    const key = r.product_title+'||'+r.sku;
    if(!grouped[key]) grouped[key] = {product_title:r.product_title, sku:r.sku, category:r.category, start_inv:r.start_inv, end_inv:r.end_inv, sold:r.sold};
    else{ grouped[key].start_inv += r.start_inv; grouped[key].end_inv += r.end_inv; grouped[key].sold += r.sold; }
  });

  const arr = Object.values(grouped);
  arr.sort((a,b)=> b.sold - a.sold);
  const totalSold = arr.reduce((s,x)=>s+x.sold,0)||1;
  let cum = 0;
  arr.forEach(it=>{
    cum += it.sold;
    const pct = (cum/totalSold)*100;
    if(pct<=80) it.ABC='A';
    else if(pct<=95) it.ABC='B';
    else it.ABC='C';
  });
  return arr;
}

function recomputeAll(){
  computed.byMonth = {};
  Object.keys(monthsData).sort().forEach(m=>{
    computed.byMonth[m] = computeABCForMonthUnits(m);
  });
  buildAggregated();
  rebuildTables();
}

function buildAggregated(){
  aggregated = {};
  const months = Object.keys(computed.byMonth).sort();
  months.forEach(m=>{
    computed.byMonth[m].forEach(it=>{
      const sku = it.sku;
      if(!aggregated[sku]) aggregated[sku] = { name: it.product_title, sku: sku, type: it.category, historyMap:{}, totalSold:0 };
      aggregated[sku].historyMap[m] = it.ABC;
      aggregated[sku].totalSold += it.sold;
    });
  });
  const lastMonth = months.length? months[months.length-1]: null;
  Object.keys(aggregated).forEach(sku=>{
    const prod = aggregated[sku];
    prod.history = months.map(m=> prod.historyMap[m] ? prod.historyMap[m] : '-');
    const scores = prod.history.filter(c=> c==='A'||c==='B'||c==='C').map(c=> abcScore(c));
    prod.avgScore = scores.length? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2) : '';
    if(lastMonth){
      const found = (computed.byMonth[lastMonth]||[]).find(x=>x.sku===sku);
      prod.latest_end = found? found.end_inv: 0;
      prod.in_stock = prod.latest_end>0;
    } else {
      prod.latest_end = 0; prod.in_stock=false;
    }
    const price = PRICE_BY_CATEGORY[prod.type] || 0;
    prod.totalRevenue = prod.totalSold * price;
  });
}

// --- UI helpers & tables ---
function refreshMonthSelects(){
  const sel = document.getElementById('monthSelectPie'); sel.innerHTML='';
  Object.keys(monthsData).sort().forEach(m=>{
    const opt = document.createElement('option');
    opt.value=m; opt.text = m; sel.appendChild(opt);
  });
}

function updateFilters(){
  const skuSel = document.getElementById('skuFilter'); skuSel.innerHTML = '<option value="all">Alle</option>';
  Object.values(aggregated).forEach(p=>{
    const opt = document.createElement('option');
    opt.value=p.sku; opt.text = `${p.name} (${p.sku})`; skuSel.appendChild(opt);
  });
  rebuildTables();
}

document.getElementById('applyFilters').addEventListener('click', ()=>rebuildTables());
document.getElementById('resetFilters').addEventListener('click', ()=>{
  document.getElementById('skuFilter').value='all';
  document.getElementById('typeFilter').value='all';
  document.getElementById('abcFilter').value='all';
  document.getElementById('stockFilter').value='all';
  rebuildTables();
});

function rebuildTables(){
  rebuildAggregatedTable();
  rebuildProductsTable();
  if(topTable) topTable.clear().draw();
  if(analysisTable) analysisTable.clear().draw();
}

function rebuildAggregatedTable(){
  if($.fn.dataTable.isDataTable('#aggregatedTable')){
    aggregatedTable.destroy();
    $('#aggregatedTable tbody').empty();
  }
  const skuFilter = document.getElementById('skuFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const abcFilter = document.getElementById('abcFilter').value;
  const stockFilter = document.getElementById('stockFilter').value;

  Object.values(aggregated).forEach(p=>{
    if(skuFilter!=='all' && p.sku !== skuFilter) return;
    if(typeFilter!=='all' && p.type !== typeFilter) return;
    if(abcFilter!=='all'){
      const latest = p.history.length? p.history[p.history.length-1] : '-';
      if(!p.history.includes(abcFilter) && latest!==abcFilter) return;
    }
    if(stockFilter==='in' && !p.in_stock) return;
    if(stockFilter==='out' && p.in_stock) return;
    const inStockText = p.in_stock? '<span class="status-yes">Ja</span>' : '<span class="status-no">Nee</span>';
    $('#aggregatedTable tbody').append(`
      <tr>
        <td>${p.name}</td>
        <td>${p.sku}</td>
        <td>${p.type}</td>
        <td>${p.history.join(', ')}</td>
        <td>${p.avgScore}</td>
        <td>${p.totalSold}</td>
        <td>${p.latest_end}</td>
        <td>${inStockText}</td>
      </tr>`);
  });
  aggregatedTable = $('#aggregatedTable').DataTable({order:[[0,'asc']]});
}

function rebuildProductsTable(){
  if($.fn.dataTable.isDataTable('#productsTable')){
    productsTable.destroy();
    $('#productsTable tbody').empty();
  }
  Object.keys(computed.byMonth).sort().forEach(m=>{
    computed.byMonth[m].forEach(item=>{
      $('#productsTable tbody').append(`<tr>
        <td>${item.product_title}</td>
        <td>${item.sku}</td>
        <td>${item.category}</td>
        <td>${m}</td>
        <td>${item.start_inv}</td>
        <td>${item.end_inv}</td>
        <td>${item.sold}</td>
        <td>${item.ABC}</td>
      </tr>`);
    });
  });
  productsTable = $('#productsTable').DataTable({order:[[0,'asc']]});
}

// --- rest van je oorspronkelijke code blijft ongewijzigd ---
$(document).ready(()=>{
  aggregatedTable = $('#aggregatedTable').DataTable();
  productsTable = $('#productsTable').DataTable();
  topTable = $('#topTable').DataTable();
  analysisTable = $('#analysisTable').DataTable();
});
</script>
