<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>ABC Analyse Webapp</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .red { background-color: #f8d7da; }
    .orange { background-color: #fff3cd; }
    .green { background-color: #d4edda; }
    .filters { margin-bottom: 15px; }
    .filters label { margin-right: 15px; }
    div.dataTables_wrapper div.dataTables_scrollHead {
      overflow: auto;
      position: relative;
    }
    div.dataTables_wrapper div.dataTables_scrollHead table {
      margin-bottom: 0 !important;
    }
  </style>
</head>
<body>
  <h1>ABC Analyse</h1>
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <p><strong>Geïmporteerde maanden:</strong> <span id="months"></span></p>

  <div class="filters">
    <label>Filter producttype:
      <select id="filterType"><option value="">Alle</option></select>
    </label>
    <label>Filter categorie:
      <select id="filterABC"><option value="">Alle</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
    </label>
    <label>Op voorraad:
      <select id="filterStock"><option value="">Alle</option><option value="Ja">Ja</option><option value="Nee">Nee</option></select>
    </label>
    <label>Dagen resterende voorraad:
      <select id="filterDays">
        <option value="">Alle</option>
        <option value="lt30">&lt; 30</option>
        <option value="30to60">30–60</option>
        <option value="gt60">&gt; 60</option>
      </select>
    </label>
  </div>

  <table id="result" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Productnaam</th>
        <th>Variant</th>
        <th>Producttype</th>
        <th>Totaal verkopen</th>
        <th>Gem. verkopen / maand</th>
        <th>Totale omzet</th>
        <th>Gem. omzet / maand</th>
        <th>ABC verloop</th>
        <th>Gem. score</th>
        <th>Voorraad</th>
        <th>Op voorraad</th>
        <th>Dagen resterende voorraad</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
// vaste prijzen
const prijzen = {
  'sokken': 10.95,
  'compressiesokken': 29.99,
  'klompen/schoenen': 79.99,
  'sneakers': 99.99,
  'mokken': 14.99
};

function abcAnalyse(producten) {
  let totaalOmzet = producten.reduce((s, p) => s + p.omzet, 0);
  producten.sort((a, b) => b.omzet - a.omzet);
  let cumulatief = 0;
  producten.forEach(p => {
    cumulatief += p.omzet;
    let aandeel = cumulatief / totaalOmzet;
    if (aandeel <= 0.8) p.cat = 'A';
    else if (aandeel <= 0.95) p.cat = 'B';
    else p.cat = 'C';
  });
  return producten;
}

function berekenVoorraadduur(eindvoorraad, gemVerkopen) {
  if (gemVerkopen === 0) return Infinity;
  return (eindvoorraad / gemVerkopen) * 30;
}

document.getElementById('upload').addEventListener('change', handleFile, false);

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const maanden = workbook.SheetNames;
    document.getElementById('months').innerText = maanden.join(', ');

    let productenMap = {};

    maanden.forEach((maand) => {
      let sheet = XLSX.utils.sheet_to_json(workbook.Sheets[maand]);
      // filter beginvoorraad = 0
      sheet = sheet.filter(r => r["Starting inventory units"] > 0);
      let producten = {};
      sheet.forEach(r => {
        let prijs = prijzen[(r["Product type"]||'').toLowerCase()] || 0;
        let omzet = r["Inventory units sold"] * prijs;
        let sku = r["Product variant SKU"];
        if (!producten[sku]) {
          producten[sku] = {
            sku: sku,
            naam: r["Product title"],
            variant: r["Product variant title"],
            type: r["Product type"],
            verkocht: 0,
            omzet: 0,
            eindvoorraad: r["Ending inventory units"]
          };
        }
        producten[sku].verkocht += r["Inventory units sold"];
        producten[sku].omzet += omzet;
        producten[sku].eindvoorraad = r["Ending inventory units"];
      });
      let arr = abcAnalyse(Object.values(producten));
      arr.forEach(p => {
        if (!productenMap[p.sku]) {
          productenMap[p.sku] = {sku: p.sku, naam: p.naam, variant:p.variant, type: p.type, verkopen:0, omzet:0, cats:[], eindvoorraad:p.eindvoorraad};
        }
        productenMap[p.sku].verkopen += p.verkocht;
        productenMap[p.sku].omzet += p.omzet;
        productenMap[p.sku].cats.push(p.cat);
        productenMap[p.sku].eindvoorraad = p.eindvoorraad;
      });
    });

    let resultaten = Object.values(productenMap).map(p => {
      let maandenCount = maanden.length;
      let gemVerkopen = p.verkopen / maandenCount;
      let gemOmzet = p.omzet / maandenCount;
      let verloop = p.cats.join('');
      let score = p.cats.reduce((s,c)=>s+(c==='A'?1:c==='B'?2:3),0)/p.cats.length;
      let voorraad = p.eindvoorraad;
      let opVoorraad = voorraad>0? "Ja":"Nee";
      let duur = berekenVoorraadduur(voorraad, gemVerkopen);
      let duurTekst = Math.round(duur);
      let kleur = duur < 30 ? 'red' : (duur < 60 ? 'orange':'green');
      return {
        sku:p.sku, naam:p.naam, variant:p.variant, type:p.type, verkopen:p.verkopen,
        gemVerkopen: gemVerkopen.toFixed(2), omzet:p.omzet.toFixed(2),
        gemOmzet:gemOmzet.toFixed(2), verloop, score:score.toFixed(2),
        voorraad, opVoorraad, duurVal: duur, duur:`<span class="${kleur}">${duurTekst}</span>`
      };
    });

    let table = $('#result').DataTable({
      destroy:true,
      data: resultaten,
      scrollX: true,
      scrollY: 500,
      scrollCollapse: true,
      paging: true,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Alle"]],
      dataSrc: "",
      columns: [
        {data:'sku'}, {data:'naam'}, {data:'variant'}, {data:'type'}, {data:'verkopen'}, {data:'gemVerkopen'},
        {data:'omzet'}, {data:'gemOmzet'}, {data:'verloop'}, {data:'score'},
        {data:'voorraad'}, {data:'opVoorraad'}, {data:'duur'}
      ]
    });

    // dropdown producttype vullen
    let types = [...new Set(resultaten.map(r=>r.type))];
    $('#filterType').empty().append('<option value="">Alle</option>');
    types.forEach(t => $('#filterType').append(`<option value="${t}">${t}</option>`));

    // filters
    $('#filterType').on('change', function(){ table.column(3).search(this.value).draw(); });
    $('#filterABC').on('change', function(){
      let val = this.value;
      if(val) table.column(8).search(val).draw();
      else table.column(8).search("").draw();
    });
    $('#filterStock').on('change', function(){ table.column(11).search(this.value).draw(); });

    $('#filterDays').on('change', function(){
      let val = this.value;
      table.rows().every(function(){
        let d = this.data();
        let show = true;
        if(val==="lt30" && !(d.duurVal < 30)) show=false;
        if(val==="30to60" && !(d.duurVal>=30 && d.duurVal<=60)) show=false;
        if(val==="gt60" && !(d.duurVal > 60)) show=false;
        if(show) $(this.node()).show(); else $(this.node()).hide();
      });
    });
  };
  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
