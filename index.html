<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABC Analyse Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1, h2 { text-align: center; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; cursor: pointer; }
  .controls { margin: 20px 0; display:flex; gap:10px; flex-wrap:wrap; }
  canvas { max-width: 25%; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>ABC Analyse Dashboard</h1>
<div class="controls">
  <input type="file" id="fileInput" accept=".csv" multiple>
  <label for="productFilter">Product (SKU):</label>
  <select id="productFilter"></select>
  <label for="typeFilter">Type:</label>
  <select id="typeFilter"><option value="">Alle</option><option value="sokken">Sokken</option><option value="compressiesokken">Compressiesokken</option><option value="klompen">Klompen</option><option value="mokken">Mokken</option><option value="sneakers">Sneakers</option></select>
  <label for="abcFilter">ABC:</label>
  <select id="abcFilter"><option value="">Alle</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
</div>
<table id="dataTable">
  <thead>
    <tr>
      <th>Product</th>
      <th>SKU</th>
      <th>Type</th>
      <th>Historie</th>
      <th>Gemiddelde</th>
      <th>Totaal verkocht</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<canvas id="pieChart"></canvas>
<canvas id="trendChart"></canvas>
<script>
let monthlyData = {};
let aggregatedData = {};

const typeMap = title => {
  title = title.toLowerCase();
  if(title.includes('compressie')) return 'compressiesokken';
  if(title.includes('sok')) return 'sokken';
  if(title.includes('klomp')) return 'klompen';
  if(title.includes('mok')) return 'mokken';
  if(title.includes('sneaker')) return 'sneakers';
  return 'overig';
};

document.getElementById('fileInput').addEventListener('change', handleFiles);
document.getElementById('productFilter').addEventListener('change', renderTable);
document.getElementById('typeFilter').addEventListener('change', renderTable);
document.getElementById('abcFilter').addEventListener('change', renderTable);

function handleFiles(evt) {
  const files = evt.target.files;
  for (let file of files) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      processCSV(file.name, text);
    };
    reader.readAsText(file);
  }
}

function processCSV(filename, csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h => h.replace(/\"/g, '').trim());
  const month = filename.match(/\d{4}-\d{2}/) ? filename.match(/\d{4}-\d{2}/)[0] : filename;
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',').map(v => v.replace(/\"/g, '').trim());
    const obj = {};
    headers.forEach((h, idx) => obj[h] = row[idx]);
    const startUnits = parseInt(obj['Starting inventory units'] || '0');
    if (startUnits > 0) {
      obj['Product type'] = typeMap(obj['Product title'] || '');
      obj['Starting inventory units'] = startUnits;
      obj['Ending inventory units'] = parseInt(obj['Ending inventory units'] || '0');
      obj['Inventory units sold'] = parseInt(obj['Inventory units sold'] || '0');
      data.push(obj);
    }
  }
  monthlyData[month] = calculateABC(data);
  aggregateProducts();
  updateProductFilter();
  renderCharts();
}

function calculateABC(data) {
  data.sort((a, b) => b['Inventory units sold'] - a['Inventory units sold']);
  const totalSold = data.reduce((sum, item) => sum + item['Inventory units sold'], 0);
  let cumulative = 0;
  for (let item of data) {
    cumulative += item['Inventory units sold'];
    const perc = (cumulative / totalSold) * 100;
    if (perc <= 80) item.ABC = 'A';
    else if (perc <= 95) item.ABC = 'B';
    else item.ABC = 'C';
  }
  return data;
}

function aggregateProducts() {
  aggregatedData = {};
  for (let month in monthlyData) {
    monthlyData[month].forEach(item => {
      const sku = item['Product variant SKU'];
      if (!aggregatedData[sku]) {
        aggregatedData[sku] = { name: item['Product title'], sku: sku, type: item['Product type'], history: [], totalSold: 0 };
      }
      aggregatedData[sku].history.push(item.ABC);
      aggregatedData[sku].totalSold += item['Inventory units sold'];
    });
  }
  for (let sku in aggregatedData) {
    aggregatedData[sku].avgScore = (aggregatedData[sku].history.reduce((sum, c) => sum + (c === 'A' ? 1 : c === 'B' ? 2 : 3), 0) / aggregatedData[sku].history.length).toFixed(2);
  }
}

function updateProductFilter() {
  const select = document.getElementById('productFilter');
  select.innerHTML = '<option value="">Alle</option>';
  Object.values(aggregatedData).forEach(prod => {
    const opt = document.createElement('option');
    opt.value = prod.sku;
    opt.textContent = prod.name;
    select.appendChild(opt);
  });
  renderTable();
}

function renderTable() {
  const productFilter = document.getElementById('productFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const abcFilter = document.getElementById('abcFilter').value;
  const tbody = document.getElementById('dataTable').querySelector('tbody');
  tbody.innerHTML = '';
  for (let prod of Object.values(aggregatedData)) {
    if ((productFilter && prod.sku !== productFilter) || (typeFilter && prod.type !== typeFilter) || (abcFilter && !prod.history.includes(abcFilter))) continue;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${prod.name}</td><td>${prod.sku}</td><td>${prod.type}</td><td>${prod.history.join(', ')}</td><td>${prod.avgScore}</td><td>${prod.totalSold}</td>`;
    tbody.appendChild(tr);
  }
}

function renderCharts() {
  const abcCounts = {A: 0, B: 0, C: 0};
  for (let month in monthlyData) {
    monthlyData[month].forEach(item => abcCounts[item.ABC]++);
  }
  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: { labels: ['A', 'B', 'C'], datasets: [{ data: [abcCounts.A, abcCounts.B, abcCounts.C], backgroundColor: ['green', 'orange', 'red'] }] }
  });
  const months = Object.keys(monthlyData).sort();
  const trendData = {A: [], B: [], C: []};
  months.forEach(month => {
    const counts = {A: 0, B: 0, C: 0};
    monthlyData[month].forEach(item => counts[item.ABC]++);
    trendData.A.push(counts.A);
    trendData.B.push(counts.B);
    trendData.C.push(counts.C);
  });
  new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: { labels: months, datasets: [ { label: 'A', data: trendData.A, borderColor: 'green', fill: false }, { label: 'B', data: trendData.B, borderColor: 'orange', fill: false }, { label: 'C', data: trendData.C, borderColor: 'red', fill: false } ] }
  });
}
</script>
</body>
</html>
