<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Product Analyse Tool</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .section { margin-bottom: 40px; }
  canvas { max-width: 600px; }
</style>
</head>
<body>

<h1>Product Analyse Tool</h1>

<!-- Upload sectie -->
<section class="section">
  <h2>Upload maandbestand</h2>
  <input type="file" id="csvFile">
  <input type="month" id="monthPicker">
  <button id="uploadBtn">Upload en verwerk</button>
</section>

<!-- Overzicht geüploade maanden -->
<section class="section">
  <h2>Geüploade maanden</h2>
  <table id="uploadedMonthsTable" class="display">
    <thead>
      <tr>
        <th>Maand</th>
        <th>Bestandsnaam</th>
        <th>Aantal producten</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Hoofd-overzicht -->
<section class="section">
  <h2>Productoverzicht</h2>
  <label>Filter op producttype:
    <select id="typeFilter">
      <option value="all">Alle</option>
      <option value="sokken">Sokken</option>
      <option value="compressiesokken">Compressiesokken</option>
      <option value="klompen">Klompen</option>
      <option value="mokken">Mokken</option>
      <option value="sneakers">Sneakers</option>
      <option value="overig">Overig</option>
    </select>
  </label>
  <label>Filter op categorie:
    <select id="abcFilter">
      <option value="all">Alle</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
    </select>
  </label>
  <label>Filter op voorraad:
    <select id="stockFilter">
      <option value="all">Alle</option>
      <option value="yes">Ja</option>
      <option value="no">Nee</option>
    </select>
  </label>
  <table id="mainTable" class="display">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Naam</th>
        <th>Categorieën</th>
        <th>Gemiddelde score</th>
        <th>Totaal verkocht</th>
        <th>Laatste voorraad</th>
        <th>Op voorraad</th>
        <th>Maanden op voorraad</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Top / Bottom verkopers -->
<section class="section">
  <h2>Top / Bottom verkopers (instelbaar)</h2>
  <label>Aantal: 
    <select id="topCountSelect">
      <option>10</option>
      <option>20</option>
      <option>50</option>
    </select>
  </label>
  <label>Filter op producttype:
    <select id="topBottomTypeFilter">
      <option value="all">Alle types</option>
      <option value="sokken">Sokken</option>
      <option value="compressiesokken">Compressiesokken</option>
      <option value="klompen">Klompen</option>
      <option value="mokken">Mokken</option>
      <option value="sneakers">Sneakers</option>
      <option value="overig">Overig</option>
    </select>
  </label>
  <h3>Top verkopers</h3>
  <table id="topTable" class="display">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Naam</th>
        <th>Categorieën</th>
        <th>Gemiddelde score</th>
        <th>Totaal verkocht</th>
        <th>Maanden op voorraad</th>
        <th>Laatste voorraad</th>
        <th>Op voorraad</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>Bottom verkopers</h3>
  <table id="bottomTable" class="display">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Naam</th>
        <th>Categorieën</th>
        <th>Gemiddelde score</th>
        <th>Totaal verkocht</th>
        <th>Maanden op voorraad</th>
        <th>Laatste voorraad</th>
        <th>Op voorraad</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Charts -->
<section class="section">
  <h2>Charts</h2>
  <label>Maand:
    <select id="monthSelectPie"></select>
  </label>
  <label>Filter op producttype:
    <select id="chartTypeFilter">
      <option value="all">Alle types</option>
      <option value="sokken">Sokken</option>
      <option value="compressiesokken">Compressiesokken</option>
      <option value="klompen">Klompen</option>
      <option value="mokken">Mokken</option>
      <option value="sneakers">Sneakers</option>
      <option value="overig">Overig</option>
    </select>
  </label>
  <div>
    <canvas id="pieChart"></canvas>
  </div>
  <div>
    <canvas id="trendChart"></canvas>
  </div>
</section>

<script>
let monthsData = {};
let computed = {products:{}, byMonth:{}};
let mainTable = null, uploadedMonthsTable = null;
let pieChart, trendChart;

function n(v){ return parseFloat(v)||0; }
function mapCategory(name){
  name = name.toLowerCase();
  if(name.includes("sok")) return "sokken";
  if(name.includes("compress")) return "compressiesokken";
  if(name.includes("klomp")) return "klompen";
  if(name.includes("mok")) return "mokken";
  if(name.includes("sneaker")) return "sneakers";
  return "overig";
}

document.getElementById('uploadBtn').addEventListener('click', ()=>{
  const file = document.getElementById('csvFile').files[0];
  const month = document.getElementById('monthPicker').value;
  if(!file){alert('Selecteer CSV bestand'); return}
  if(!month){alert('Selecteer een maand'); return}
  Papa.parse(file, {
    header:true,
    skipEmptyLines:true,
    complete: res=>{
      const normalizeKey = k => (k||'').toString().trim().toLowerCase();
      const rows = res.data.map(r=>{
        const obj = {};
        for(const key in r) obj[normalizeKey(key)] = r[key];
        return {
          product_title: obj['product title'] || '',
          sku: obj['product variant sku'] || obj['sku'] || '',
          start_inv: n(obj['starting inventory units']),
          end_inv: n(obj['ending inventory units']),
          sold: n(obj['inventory units sold']),
          category: mapCategory(obj['product title']||''),
        };
      });
      rows.fileName = file.name;
      monthsData[month] = rows;
      recomputeAll();
      refreshUploadedMonthsTable();
      updateFilters();
    }
  });
});

function refreshUploadedMonthsTable(){
  if(uploadedMonthsTable){ uploadedMonthsTable.destroy(); $('#uploadedMonthsTable tbody').empty(); }
  Object.keys(monthsData).sort().forEach(m=>{
    const rows = monthsData[m];
    $('#uploadedMonthsTable tbody').append(`<tr><td>${m}</td><td>${rows.fileName||'-'}</td><td>${rows.length}</td></tr>`);
  });
  uploadedMonthsTable = $('#uploadedMonthsTable').DataTable();
}

function recomputeAll(){
  computed = {products:{}, byMonth:{}};
  for(const m in monthsData){
    const rows = monthsData[m];
    const sorted = [...rows].sort((a,b)=>b.sold-a.sold);
    let totalSold = sorted.reduce((sum,r)=>sum+r.sold,0);
    let cum=0;
    sorted.forEach(r=>{
      cum += r.sold;
      let abc = cum/totalSold<=0.8 ? 'A' : cum/totalSold<=0.95 ? 'B' : 'C';
      if(!computed.byMonth[m]) computed.byMonth[m] = [];
      computed.byMonth[m].push({...r, ABC:abc});
      if(!computed.products[r.sku]) computed.products[r.sku] = {
        sku: r.sku, name: r.product_title, category: r.category,
        categories: [], avgScore:0, totalSold:0, monthsInStock:0,
        latestStock:0, inStockNow:false
      };
      let prod = computed.products[r.sku];
      prod.categories.push(abc);
      prod.totalSold += r.sold;
      if(r.end_inv>0) prod.monthsInStock++;
      if(m===Object.keys(monthsData).sort().slice(-1)[0]){
        prod.latestStock = r.end_inv;
        prod.inStockNow = r.end_inv>0;
      }
    });
  }
  for(const sku in computed.products){
    let p = computed.products[sku];
    p.avgScore = p.categories.map(c=>c==='A'?1:c==='B'?2:3).reduce((a,b)=>a+b,0)/p.categories.length;
  }
  refreshMainTable();
  refreshTopBottomTables();
  refreshMonthSelects();
  updateCharts();
}

function refreshMainTable(){
  const typeF = $('#typeFilter').val(), abcF = $('#abcFilter').val(), stockF = $('#stockFilter').val();
  const data = Object.values(computed.products).filter(p=>{
    if(typeF!=='all' && p.category!==typeF) return false;
    if(abcF!=='all' && !p.categories.includes(abcF)) return false;
    if(stockF==='yes' && !p.inStockNow) return false;
    if(stockF==='no' && p.inStockNow) return false;
    return true;
  });
  if(mainTable){ mainTable.clear().destroy(); }
  const tbody = $('#mainTable tbody').empty();
  data.forEach(p=>{
    tbody.append(`<tr>
      <td>${p.sku}</td><td>${p.name}</td><td>${p.categories.join(', ')}</td>
      <td>${p.avgScore.toFixed(2)}</td><td>${p.totalSold}</td>
      <td>${p.latestStock}</td><td>${p.inStockNow?'Ja':'Nee'}</td>
      <td>${p.monthsInStock}</td></tr>`);
  });
  mainTable = $('#mainTable').DataTable();
}

function refreshTopBottomTables(){
  const typeFilter = $('#topBottomTypeFilter').val();
  let allProducts = Object.values(computed.products);
  if(typeFilter !== 'all'){ allProducts = allProducts.filter(p => p.category === typeFilter); }
  const sorted = [...allProducts].sort((a,b)=>{
    if(a.avgScore !== b.avgScore) return a.avgScore - b.avgScore;
    if(a.monthsInStock !== b.monthsInStock) return b.monthsInStock - a.monthsInStock;
    return b.totalSold - a.totalSold;
  });
  const topCount = parseInt($('#topCountSelect').val())||10;
  fillTable('#topTable', sorted.slice(0, topCount));
  fillTable('#bottomTable', sorted.slice(-topCount).reverse());
}

function fillTable(id, list){
  const table = $(id).DataTable();
  table.clear();
  list.forEach(p=>{
    table.row.add([p.sku,p.name,p.categories.join(', '),p.avgScore.toFixed(2),p.totalSold,p.monthsInStock,p.latestStock,p.inStockNow?'Ja':'Nee']);
  });
  table.draw();
}

function refreshMonthSelects(){
  const sel = $('#monthSelectPie').empty();
  Object.keys(monthsData).sort().forEach(m=> sel.append(`<option>${m}</option>`));
}

function updateCharts(){
  const month = $('#monthSelectPie').val();
  const typeFilter = $('#chartTypeFilter').val();
  if(!month) return;
  const data = computed.byMonth[month]||[];
  const filtered = typeFilter==='all'? data : data.filter(r=>r.category===typeFilter);
  const grouped = {A:0,B:0,C:0};
  filtered.forEach(r=> grouped[r.ABC]++);
  pieChart.data.datasets[0].data = [grouped.A, grouped.B, grouped.C];
  pieChart.update();
  const months = Object.keys(computed.byMonth).sort();
  const trendData = {A:[],B:[],C:[]};
  months.forEach(m=>{
    const list = typeFilter==='all'? computed.byMonth[m] : computed.byMonth[m].filter(r=>r.category===typeFilter);
    const g={A:0,B:0,C:0};
    list.forEach(r=>g[r.ABC]++);
    const total = g.A+g.B+g.C||1;
    trendData.A.push((g.A/total*100).toFixed(2));
    trendData.B.push((g.B/total*100).toFixed(2));
    trendData.C.push((g.C/total*100).toFixed(2));
  });
  trendChart.data.labels = months;
  trendChart.data.datasets[0].data = trendData.A;
  trendChart.data.datasets[1].data = trendData.B;
  trendChart.data.datasets[2].data = trendData.C;
  trendChart.update();
}

$('#typeFilter,#abcFilter,#stockFilter').on('change', refreshMainTable);
$('#topCountSelect,#topBottomTypeFilter').on('change', refreshTopBottomTables);
$('#monthSelectPie,#chartTypeFilter').on('change', updateCharts);

$(document).ready(()=>{
  uploadedMonthsTable = $('#uploadedMonthsTable').DataTable();
  $('#topTable').DataTable(); $('#bottomTable').DataTable();
  pieChart = new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {labels:['A','B','C'], datasets:[{data:[0,0,0], backgroundColor:['green','orange','red']}]}
  });
  trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels:[],
      datasets:[
        {label:'A (%)', data:[], borderColor:'green', fill:false},
        {label:'B (%)', data:[], borderColor:'orange', fill:false},
        {label:'C (%)', data:[], borderColor:'red', fill:false}
      ]
    }
  });
});
</script>

</body>
</html>
