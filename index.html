<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABC Analyse Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1, h2 { text-align: center; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; cursor: pointer; }
  .controls { margin: 20px 0; display: flex; gap: 10px; }
  .abc-A { background-color: #90ee90; }
  .abc-B { background-color: #ffcc80; }
  .abc-C { background-color: #ff9999; }
  canvas { max-width: 50%; height: auto; }
</style>
</head>
<body>
<h1>ABC Analyse Dashboard</h1>
<div class="controls">
  <input type="file" id="fileInput" accept=".csv" multiple>
  <label for="monthSelect">Kies maand:</label>
  <select id="monthSelect"></select>
  <label for="skuFilter">Product filter:</label>
  <select id="skuFilter"></select>
  <label for="abcFilter">Categorie filter:</label>
  <select id="abcFilter">
    <option value="">Alle</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
  </select>
</div>
<div id="summary"></div>
<canvas id="pieChart"></canvas>
<canvas id="trendChart"></canvas>
<table id="dataTable">
  <thead>
    <tr>
      <th>Product</th>
      <th>SKU</th>
      <th>ABC historie</th>
      <th>Gemiddelde score</th>
      <th>Totaal verkocht</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let monthlyData = {};
let skuHistory = {};

document.getElementById('fileInput').addEventListener('change', handleFiles);
document.getElementById('monthSelect').addEventListener('change', renderTable);
document.getElementById('skuFilter').addEventListener('change', renderTable);
document.getElementById('abcFilter').addEventListener('change', renderTable);

function handleFiles(evt) {
  const files = evt.target.files;
  for (let file of files) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      processCSV(file.name, text);
    };
    reader.readAsText(file);
  }
}

function processCSV(filename, csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h => h.replace(/\"/g, '').trim());
  const month = filename.match(/\d{4}-\d{2}/) ? filename.match(/\d{4}-\d{2}/)[0] : filename;
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',').map(v => v.replace(/\"/g, '').trim());
    const obj = {};
    headers.forEach((h, idx) => obj[h] = row[idx]);
    const startUnits = parseInt(obj['Starting inventory units'] || '0');
    if (startUnits > 0) {
      obj['Starting inventory units'] = startUnits;
      obj['Ending inventory units'] = parseInt(obj['Ending inventory units'] || '0');
      obj['Inventory units sold'] = parseInt(obj['Inventory units sold'] || '0');
      data.push(obj);
    }
  }
  monthlyData[month] = calculateABC(data);
  updateSKUHistory(month);
  updateMonthSelect();
  updateSKUFilter();
  renderCharts();
}

function calculateABC(data) {
  data.sort((a, b) => b['Inventory units sold'] - a['Inventory units sold']);
  const totalSold = data.reduce((sum, item) => sum + item['Inventory units sold'], 0);
  let cumulative = 0;
  for (let item of data) {
    cumulative += item['Inventory units sold'];
    const perc = (cumulative / totalSold) * 100;
    if (perc <= 80) item.ABC = 'A';
    else if (perc <= 95) item.ABC = 'B';
    else item.ABC = 'C';
  }
  return data;
}

function updateSKUHistory(month) {
  for (let item of monthlyData[month]) {
    const sku = item['Product variant SKU'];
    if (!skuHistory[sku]) {
      skuHistory[sku] = { name: item['Product title'], history: [], totalSold: 0 };
    }
    skuHistory[sku].history.push(item.ABC);
    skuHistory[sku].totalSold += item['Inventory units sold'];
  }
}

function updateMonthSelect() {
  const select = document.getElementById('monthSelect');
  select.innerHTML = '';
  Object.keys(monthlyData).sort().forEach(month => {
    const opt = document.createElement('option');
    opt.value = month;
    opt.textContent = month;
    select.appendChild(opt);
  });
}

function updateSKUFilter() {
  const select = document.getElementById('skuFilter');
  select.innerHTML = '<option value="">Alle producten</option>';
  Object.keys(skuHistory).forEach(sku => {
    const opt = document.createElement('option');
    opt.value = sku;
    opt.textContent = skuHistory[sku].name + ' (' + sku + ')';
    select.appendChild(opt);
  });
}

function renderTable() {
  const tbody = document.getElementById('dataTable').querySelector('tbody');
  tbody.innerHTML = '';
  const skuFilter = document.getElementById('skuFilter').value;
  const abcFilter = document.getElementById('abcFilter').value;

  Object.entries(skuHistory).forEach(([sku, data]) => {
    if (skuFilter && sku !== skuFilter) return;
    if (abcFilter && !data.history.includes(abcFilter)) return;
    const avgScore = (data.history.reduce((sum, val) => sum + (val === 'A' ? 1 : val === 'B' ? 2 : 3), 0) / data.history.length).toFixed(2);
    const tr = document.createElement('tr');
    tr.className = 'abc-' + data.history[data.history.length - 1];
    tr.innerHTML = `
      <td>${data.name}</td>
      <td>${sku}</td>
      <td>${data.history.join(', ')}</td>
      <td>${avgScore}</td>
      <td>${data.totalSold}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderCharts() {
  const month = document.getElementById('monthSelect').value || Object.keys(monthlyData)[0];
  if (!month) return;
  const counts = {A:0,B:0,C:0};
  monthlyData[month].forEach(item => counts[item.ABC]++);

  const pieCtx = document.getElementById('pieChart').getContext('2d');
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: ['A', 'B', 'C'],
      datasets: [{
        data: [counts.A, counts.B, counts.C],
        backgroundColor: ['green', 'orange', 'red']
      }]
    }
  });

  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const months = Object.keys(monthlyData).sort();
  const aData = months.map(m => monthlyData[m].filter(i => i.ABC === 'A').length);
  const bData = months.map(m => monthlyData[m].filter(i => i.ABC === 'B').length);
  const cData = months.map(m => monthlyData[m].filter(i => i.ABC === 'C').length);

  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: 'A', data: aData, borderColor: 'green', fill: false },
        { label: 'B', data: bData, borderColor: 'orange', fill: false },
        { label: 'C', data: cData, borderColor: 'red', fill: false }
      ]
    }
  });
}
</script>
</body>
</html>
